# üîë Keys ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏° - ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

## ‚ùì ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢

### 1. ‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà transfer file ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?

**‡πÉ‡∏ä‡πà‡∏Ñ‡∏£‡∏±‡∏ö!** ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏°‡∏µ 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Step 1: Transfer File (USB)                            ‚îÇ
‚îÇ  PC Backend ‚îÄ‚îÄUSB‚îÄ‚îÄ> Switch Client ‚îÄ‚îÄ> /switch/downloads‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  Step 2: Install Game (NCM API)                         ‚îÇ
‚îÇ  /switch/downloads/game.nsp ‚îÄ‚îÄNCM‚îÄ‚îÄ> NAND/SD (installed)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Step 1: Transfer (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß)

- ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå NSP/NSZ ‡∏à‡∏≤‡∏Å PC ‡∏ú‡πà‡∏≤‡∏ô USB
- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á SD card ‡∏ó‡∏µ‡πà `/switch/downloads/`
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß 40-50 MB/s

#### Step 2: Install (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)

- ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå NSP ‡∏î‡πâ‡∏ß‡∏¢ `fs` API
- ‡πÅ‡∏ï‡∏Å NCA (Nintendo Content Archive) files
- ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ NCM (Nintendo Content Manager) API
- Verify signatures
- Register ‡∏Å‡∏±‡∏ö system

### 2. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ prod.keys ‡∏´‡∏£‡∏∑‡∏≠ title.keys ‡πÑ‡∏´‡∏°?

**‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö!** ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:

#### Keys ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?

```
SD Card Structure:
/atmosphere/
‚îú‚îÄ‚îÄ prod.keys          ‚Üê System keys (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
‚îú‚îÄ‚îÄ title.keys         ‚Üê Title-specific keys (optional)
‚îî‚îÄ‚îÄ contents/          ‚Üê Installed games
```

#### ‡πÉ‡∏Ñ‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Keys?

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Your Client  ‚îÇ ‚îÄ‚îÄcalls‚îÄ‚îÄ> ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ (SwitchLink) ‚îÇ            ‚îÇ libnx    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                            calls ‚îÇ
                                  ‚ñº
                            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ NCM API  ‚îÇ ‚îÄ‚îÄreads‚îÄ‚îÄ> ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                            ‚îÇ (System) ‚îÇ            ‚îÇ prod.keys   ‚îÇ
                            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ (Atmosph√®re)‚îÇ
                                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**‡∏™‡∏£‡∏∏‡∏õ**: Atmosph√®re ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ keys ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∏‡πà‡∏á!

## üõ†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á NSP - Technical Details

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

```cpp
// 1. Initialize NCM
ncmInitialize();
nsInitialize();

// 2. Open content storage
NcmContentStorage storage;
NcmStorageId storageId = NcmStorageId_SdCard; // ‡∏´‡∏£‡∏∑‡∏≠ NcmStorageId_BuiltInUser
ncmOpenContentStorage(&storage, storageId);

// 3. Open NSP file
FsFileSystem fs;
fsOpenFileSystemWithId(&fs, 0, FsFileSystemType_ApplicationPackage, path);

// 4. Read and install NCAs
// - Extract NCA files from NSP
// - Verify signatures (‡πÉ‡∏ä‡πâ keys ‡∏à‡∏≤‡∏Å Atmosph√®re)
// - Install to content storage
ncmContentStorageRegister(&storage, &contentId, &placeholderId);

// 5. Register with system
nsCountApplicationContentMeta(&count);
nsListApplicationRecordContentMeta(&record);

// 6. Cleanup
ncmContentStorageClose(&storage);
ncmExit();
nsExit();
```

### ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

#### ‡∏ö‡∏ô Switch (SD Card):

```
/atmosphere/
‚îú‚îÄ‚îÄ prod.keys          ‚úÖ ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Atmosph√®re)
‚îú‚îÄ‚îÄ title.keys         ‚ö†Ô∏è  Optional (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö encrypted titles)
‚îî‚îÄ‚îÄ contents/          ‚úÖ ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (Atmosph√®re ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ)

/switch/
‚îú‚îÄ‚îÄ switchlink-client.nro  ‚úÖ Client ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
‚îî‚îÄ‚îÄ downloads/             ‚úÖ Temp folder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà download
```

#### ‡∏ö‡∏ô PC:

```
/home/dit/Sites/dbi-backend-gui/
‚îú‚îÄ‚îÄ target/release/dbi-backend-rust  ‚úÖ Backend
‚îî‚îÄ‚îÄ games/                            ‚úÖ NSP/NSZ files
```

## üìù ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Client

### 1. NSP Installer Module

```cpp
class NSPInstaller {
    // ‡πÉ‡∏ä‡πâ NCM API ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á NSP
    bool installNSP(const char* path);

    // ‡πÉ‡∏ä‡πâ NS API register ‡∏Å‡∏±‡∏ö system
    bool registerApplication(u64 titleId);

    // Verify installation
    bool verifyInstalled(u64 titleId);
};
```

### 2. Workflow ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

```
1. USB Transfer
   ‚îú‚îÄ> Download NSP from PC
   ‚îú‚îÄ> Save to /switch/downloads/
   ‚îî‚îÄ> Show progress (40-50 MB/s)

2. NSP Installation
   ‚îú‚îÄ> Open NSP file
   ‚îú‚îÄ> Extract NCAs
   ‚îú‚îÄ> Verify signatures (‡πÉ‡∏ä‡πâ prod.keys ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
   ‚îú‚îÄ> Install to NAND/SD
   ‚îî‚îÄ> Register with system

3. Verification
   ‚îú‚îÄ> Check installation status
   ‚îú‚îÄ> Verify title ID
   ‚îî‚îÄ> Show success message

4. Cleanup
   ‚îî‚îÄ> Delete temp file (optional)
```

## üîê Security & Keys

### prod.keys ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?

```
# prod.keys format
master_key_00 = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
master_key_01 = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
...
header_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

**‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö**:

- Decrypt NCA headers
- Verify signatures
- Decrypt game content

### title.keys ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?

```
# title.keys format
TITLE_ID = TITLE_KEY
01234567890ABCDEF = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

**‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö**:

- Decrypt specific titles
- Optional (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NSP ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà)

### Client ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?

**‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢!** ‡πÄ‡∏û‡∏£‡∏≤‡∏∞:

1. Keys ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `/atmosphere/prod.keys`
2. Atmosph√®re mount keys ‡πÉ‡∏´‡πâ system
3. NCM API ‡∏≠‡πà‡∏≤‡∏ô keys ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
4. ‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

### 1. Storage Space

```cpp
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
s64 freeSpace;
nsGetFreeSpaceSize(NcmStorageId_SdCard, &freeSpace);

if (freeSpace < fileSize * 2) {
    printf("Not enough space!\n");
    return false;
}
```

### 2. Corrupted NSP

```cpp
// Verify NSP integrity
bool verifyNSP(const char* path) {
    // Check file size
    // Verify PFS0 header
    // Check NCA signatures
}
```

### 3. Installation Errors

```cpp
// Handle common errors
switch (rc) {
    case 0x234C02:  // Insufficient space
    case 0x234E02:  // Invalid NCA
    case 0x235002:  // Signature verification failed
    // ...
}
```

## üéØ ‡∏™‡∏£‡∏∏‡∏õ

### ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:

1. **‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á client ‡πÑ‡∏´‡∏°?**

   - ‚úÖ **‡πÉ‡∏ä‡πà** - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ NCM API ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ
   - ‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà copy file

2. **‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ prod.keys ‡πÑ‡∏´‡∏°?**

   - ‚úÖ **‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ** - ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Atmosph√®re ‡πÅ‡∏•‡πâ‡∏ß
   - ‚ùå Client ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á

3. **‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ title.keys ‡πÑ‡∏´‡∏°?**
   - ‚ö†Ô∏è **Optional** - ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö title
   - ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô

### Next Steps:

1. ‚úÖ Transfer file ‡∏ú‡πà‡∏≤‡∏ô USB (‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß)
2. ‚è≥ ‡πÄ‡∏û‡∏¥‡πà‡∏° NSP installer (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥)
3. ‚è≥ ‡πÉ‡∏ä‡πâ NCM API (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥)
4. ‚è≥ Error handling (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥)

---

**‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° NSP installer module ‡πÉ‡∏´‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?** üéÆ
